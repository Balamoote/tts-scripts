# tts-scripts

Скрипты для предварительной обработки текста книг в форматах fb2 и txt для их прослушивания в text-to-speech движках \*

Возможно использовать совместно со скриптом обработки книг fb2: https://github.com/Balamoote/fb2-scripts</br>

Скрипты в основном предназначены для получения улучшенного звучания за счёт проставления ударений на движках TTS, которые понимают ударения.</br>

Скрипты могут рассматриваться также как инструмент предварительной обработки текста перед его обработкой пакетом ruaccent, который находится тут:</br>
https://github.com/Den4ikAI/ruaccent .

При желании можно использовать:

- с TTSLexx, находящимся тут: https://play.google.com/store/apps/details?id=sia.netttsengine.ttslexx</br>
- со словарем, находящимся тут: https://github.com/Balamoote/gtts-dic (устарело)</br>

Задача коррекции звучания на конкретном движке решается путем составления корректировочных словарей, которые на входе принимаю уже размеченный
ударениями текст, а на выходе выдают результат, понятный TTS-движку. Пример в директории slexx для TTSLexx.

При использовании дополнительно к автоматической ещё и ручной обработки омографов через дискретные скрипты, при желании, можно добиться 100% обработки всех
омографов в тексте.

Документация находится внутри папки tools/docs (устарела), а также в самих скриптах.

Рекомендуется до начала работы нормализовать текст: ./fb2fix.sh -gc book.fb2 = делает почти то же, что и "генеральная уборка" в FictionBook Editor).
Или воспользоваться скриптами FictionBook Editor для чистки текста.</br>

Как это работает?

Общая задача: а) разрешение омографов; б) поставить ударения в не-омографах; в) ёфицировать текст. Ничего сверх этого. Пакет ruaccent делает всё это автоматически
и можно просто использовать. Но имеется возможность сделать несколько дополнительных шагов, чтобы улучшить результат ценой некоторых затрат времени. Описанные ниже
пункты являются опциональными

1. ./yofik.sh -gg book.fb2 = ёфикация, кроме омографов, которые при желании можно обработать вручную. Команда создает директорию с дискретными скриптами для ручной
   обработки каждого ё-омографа.</br>

2. 1. ./lexxer.sh -gg book.fb2 = проставить ударения в известных именах и собрать неизвестные имена и слова для внесения в базы. Команда создает директорию с
      дискретными скриптами для ручной обработки каждого омографа-имени/названия.</br>

3. 2. ./lexxer.sh -dixa book.fb2 = проставить ударения во всех словах, не являющихся омографами. Отличие от 2.1 в том, что обрабатываются и имена/названия и обычные слова.
      Имеет смысл запускать ./yofik.sh после п.2.2, чтобы доработать несколько ё-омографов в однозначных позициях, если не будет задействован п.3.1. и не был задействован п.1.</br>

Словари ударений tts-scripts и ruaccenta в общем случае не совпадают и имеет смысл выполнить ./lexxer.sh -dixa book.fb2 до обработки ruaccent’ом, т.к. скорее всего
словарь из этого пакета имеет больший охват. В этом случае ruaccent будет меньше "отгадывать" ударения в неизвестных словах и вероятность ошибок будет меньше. Разница
в словарях, например, на март 2025 составляет 1,7 млн. словоформ. С новыми релизами ruaccent разница будет не столь значительной, но это на вопрос наполнения словарей
стоит обратить внимание. "Разницу" ruaccent достаточно неплохо угадывает, но точность всё равно не может быть 100%, в отличие от словаря подстановки, где ошибки единичны.

3. 1. ./momo.sh -gg book.fb2 = выполнить автообработку части омографов и при желании вручную обработать остатки дискретными скриптами. В основном эта команда — это замена
      ruaccent’a. В практическом смысле это означает, что ошибки могут быть в других местах, но автоматический охват будет существенно меньше.</br>

4. 2. ./momo.sh -pf book.fb2 = создать дискретные скриптами для ручной обработки омографов. Автоматическая обработка омографов не производится и передаётся всецело
      ruaccent’у.</br>

Примечание: пп. 3.1 и 3.2 создают дискретные скрипты для всех известных омографов, в отличие от пп. 2.1 и 2.2, где дискретные скрипты создаются только для слова, которые
могут быть именами ил названиями.

После этого можно сразу использовать пакет ruaccent, не тратя время на ручную обработку.

4. ./momo.sh -ruac book.fb2 = выполнить автообработку всех слов текста, включая омографы, и ёфикацию. Особенность: уже проставленные ударения остаются на месте.</br>

Настройку работы ruaccent можно сделать в файле scripts/ruac.py</br>

5. Скрипт ./stripper.sh позволяет откатить либо все изменения или только некоторые из них (тут ещё не доделана очистка группы).

6. В планах отдельный скрипт, который в полностью обработанный текст вносит правки, которые исправляют произношение конкретного tts-движка.

Перед началом работы или после внесений любых изменений в базы рекомендуется запустить ./check-all.sh , который создаст все необходимые для работы файлы.</br>

Дискретные скрипты</br>
Концепция дискретных скриптов в том, чтобы иметь возможность обработать каждый найденные омограф вручную из командной строки и/ими из vim/neovim. Такие скрипты
генерируются как результат работы трёх скриптов: ./yofik.sh, ./lexxer.sh, ./momo.sh и находятся в директория с названиями, состоящими соответственно из
префиксов yomo-, nomo-, momo- и названия книги. Целевым файлом скриптов может являться либо основной файл, либо его бэкап и нужно обратить внимание на то, чтобы
проделанная работа не пропала при повторном запуске основных скриптов.</br>
В шапке каждого скрипта находится описание его работы и видны конечные формы омографов. В командной строке можно выбрать номер формы, указав ее в качестве аргумента.
Например, ./берег.sh 1 заменит все "берег" в тексте на "бе́рег" в тексте, а ./берег.sh 1 21388 сделает замену только в строке 21388. Отрывки текста, где "берег"
встречается даны в самом дискретном скрипте и их можно просмотреть, перед тем как выбрать варианты.
Если запустить дискретный скрипт без аргументов, то можно будет обработать каждый случай в тексте (для одного омографа) интерактивно, выбирая один из вариантов. Для
этого в vim/neovim должен быть установлен плагин https://github.com/inkarkat/vim-PatternsOnText .

В tools находится рабочий комплект для обработки книг.</br>

Для скрипта ./momo.sh есть возможность включить GNU Parallel и значительно увеличить скорость работы. См. переменную do_parallel=1 в самом скрипте.

Скрипт ./hclean.sh в scriptdb/ может быть вызван с ключами spell_all, spell_flat которые дадут списки слов для последующей генерации словарей проверки орфографии,
например для vim/neovim. Обратите внимание, что этот скрипт сразу устанавливает готовый словарь для vim -- измените при необходимости.

Словарные базы.
Скрипты работают на основе нескольких словарных баз, в зависимости от назначения скриптов. Основными источниками являются:

1. "Полная парадигма. Морфология. Частотный словарь. Совмещенный словарь. Автор М. Хаген. Полная парадигма. Морфология". http://speakrus.ru/dict2/index.htm#morph-paradigm
   является основой, исправляется и дополняется;
2. Wiktionary https://ru.wiktionary.org/ - является источником пополнения словарных баз (см. https://kaikki.org/dictionary/rawdata.html);
3. «Открытый корпус» (OpenCorpora) https://opencorpora.org/dict.php - является источником пополнения словарных баз;
4. YOL https://github.com/vgiv/yo - основа базы ёфикации, исправлена и дополнена.

5. Описание баз ударений находится в scripts/unistress.me

Словарные базы разделяются на две независимые части. Первая часть (dic*/dix*) обеспечивает морфологический анализ текста, она направлена на обработку омографов правилами,
не содержит ударений. Вторая часть состоит из списков слов с ударениями. Базы между собой не связаны и не синхронизированы. Ожидается что практически все слова из словарей
лексики находятся в словарях ударений. Обратное неверно.

Требования:</br>
bash, grep, GNU sed, gawk>=5.2.1, dos2unix, uniq, sort, md5sum, zgrep, zcat, md5sum, gzip, bc

Рекомендации:</br>
iconv, mc, vim/nvim, GNU parallel, ripgrep, ruaccent, (natasha), (spacy)

\* Название репозитария было изменено с gtts-scripts в связи с тем, что gtts перестал быть целевым движком для скриптов. Цель: простановка ударений для любого tts-движка.
